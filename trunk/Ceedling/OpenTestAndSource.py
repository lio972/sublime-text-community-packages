import sublime, sublimeplugin, re

class OpenTestAndSourceCommand(sublimeplugin.TextCommand):

    def run(self, view, args):
        file_path = view.fileName()
        if re.search(r"\w+\.[ch]", file_path):
            window = view.window()
            window.runCommand('layoutDoubleVert')

            base_name = re.search(r"(\w+)\.[ch]", file_path).group(1)
            base_name = re.sub('^test_', '', base_name)
            
            proj_files = window.project().mountPoints()[0]['files']
            src_matcher = re.compile("\\\\" + base_name + "\.c$")
            test_matcher = re.compile("\\\\test_" + base_name + "\.c$")

            src_loaded = False
            test_loaded = False
            for f in proj_files:
                if src_matcher.search(f):
                    cur_view = window.openFile(f)
                    window.setViewPosition(cur_view, 1, 0)
                    src_loaded = True
                elif test_matcher.search(f):
                    cur_view = window.openFile(f)
                    window.setViewPosition(cur_view, 0, 0)
                    test_loaded = True

                if src_loaded and test_loaded:
                    break